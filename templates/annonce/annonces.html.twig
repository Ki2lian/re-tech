{% extends 'base.html.twig' %}
{% set iDontKnow = annonces | json_encode %}

{% block title %}Annonces{% endblock %}

{% set wishlistIdAnnonce = [] %}
{% for wish in wishlist %}
	{% set wishlistIdAnnonce = wishlistIdAnnonce|merge([wish.id_annonce.id]) %}
{% endfor %}

{% block body %}
	<div class="row">
		<div class="col-12 bg-white">
			<div class="page-title-box">
				<div class="page-title-left">
					<ol class="breadcrumb m-0 p-2">
						<li class="breadcrumb-item">
							<a href="{{ path('accueil') }}">Accueil</a>
						</li>
						<li class="breadcrumb-item active">Annonces</li>
					</ol>
				</div>
			</div>
		</div>
	</div>

	<div class="container mt-3">
		<div class="row">
			<div class="col-lg-2">
				<section>
					<section class="mb-4">
						<h6 class="font-weight-bold mb-3">Marque</h6>
						<div class="form-check pl-0 mb-3">
							<input type="checkbox" class="form-check-input filled-in" id="new">
							<label class="form-check-label small card-link-secondary" for="new">iPhone</label>
						</div>
						<div class="form-check pl-0 mb-3">
							<input type="checkbox" class="form-check-input filled-in" id="used">
							<label class="form-check-label small card-link-secondary" for="used">Samsung</label>
						</div>
						<div class="form-check pl-0 mb-3">
							<input type="checkbox" class="form-check-input filled-in" id="collectible">
							<label class="form-check-label small card-link-secondary" for="collectible">LG</label>
						</div>

						<a class="greylink" data-bs-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
							Voir plus
						</a>
						<div class="collapse" id="collapseExample">
							<div class="form-check pl-0 mb-3">
								<input type="checkbox" class="form-check-input filled-in" id="collectible">
								<label class="form-check-label small card-link-secondary" for="collectible">Huawei</label>
							</div>
							<div class="form-check pl-0 mb-3">
								<input type="checkbox" class="form-check-input filled-in" id="collectible">
								<label class="form-check-label small card-link-secondary" for="collectible">Xiaomi</label>
							</div>
							<div class="form-check pl-0 mb-3">
								<input type="checkbox" class="form-check-input filled-in" id="collectible">
								<label class="form-check-label small card-link-secondary" for="collectible">Sony</label>
							</div>
						</div>
					</section>
					<section class="mb-4">
						<h6 class="font-weight-bold mb-3">Prix</h6>
						<form>
							<div class="price align-items-center mt-4 pb-1">
								<div class="md-form md-outline my-0">
									<label for="from">Minimum</label>
									<input id="from" type="text" class="form-control mb-0">
								</div>
								<div class="md-form md-outline my-0">
									<label for="to">Maximum</label>
									<input id="to" type="text" class="form-control mb-0">
								</div>
							</div>
						</form>
					</section>
				</section>
			</div>
			<div class="col-lg-10">
				<div class="row annonces">
					{% for annonce in annonces %}
					{% set imgUrl = null %}
						<div class="col-xl-4 col-lg-6 col-md-6 mb-4 item">
							<div class="card annonce ribbon-box">
								{% for image in annonce.images %}
									{% if image.presentation %}
										{% set imgUrl = image.nom %}
									{% endif %}
								{% endfor %}
								<a href="{{ path('annonce-single', {'id': annonce.id}) }}">
									<img class="card-img-top" src="{{ asset('/uploads/'~imgUrl) }}" alt="Image de l'article {{ annonce.titre }}"/>
								</a>
								<div class="card-body">
								{% if annonce.annonce_payante %}
								<div class="ribbon-two ribbon-two-info"><span>Sponsorisé</span></div>
								{% endif %}
									<a href="{{ path('annonce-single', {'id': annonce.id}) }}">
										<h3 class="card-title mb-3">{{ annonce.titre }}</h3>
									</a>
									<div class="d-flex justify-content-between h2">
									{% if annonce.id_compte.id != app.user.id %}
										<span data-id="{{ annonce.id }}">
										{% if annonce.id in wishlistIdAnnonce %}
											<i class="fas fa-heart"></i>
										{% else %}
											<i class="far fa-heart"></i>
										{% endif %}
									{% endif %}
										</span>
										<p class="price">{{ annonce.prix }}€</p>
									</div>
								</div>
							</div>
						</div>
					{% endfor %}
					<div class="pagination">
						{% if tag %}
							<a href="{{ path('annonces-tag', {'id': id+1, 'nom': nom }) }}" class="next">Next</a>
						{% else %}
							<a href="{{ path('annonces', {'id': id+1 }) }}" class="next">Next</a>
						{% endif %}
					</div>
					<div class="d-flex justify-content-center">
						<i class="fas fa-sync fa-spin fa-3x"></i>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	<script src="https://unpkg.com/@webcreate/infinite-ajax-scroll@^3.0.0-beta.6/dist/infinite-ajax-scroll.min.js"></script>
	<script src="{{ asset('js/wishlist.js') }}"></script>
	<script>
		$(document).ready(function(){
			const maxPage = {{ nbPage }}
			var ias = new InfiniteAjaxScroll('.annonces', {
				item: '.item',
				next: '.next',
				pagination: '.pagination',
				logger: false,
				spinner: '.fas.fa-sync',
				logger: {
					page: (event) => {
						currentPage = event.url.split('/').at(-1)[0];
						if(parseInt(currentPage) === maxPage) ias.disableLoadOnScroll();
					}
				}
			});
			if(maxPage == 0) ias.disableLoadOnScroll();

			var block = false;
			$('body').on('click', '.annonce .fa-heart', function(){
				if(block) return;
				block = !block;
                toggleWishlist('{{ path('wishlist_toggler') }}', $(this))
				setTimeout(() => {
					block = !block;
				}, 1000);
				
            });
		});
	</script>
{% endblock %}
